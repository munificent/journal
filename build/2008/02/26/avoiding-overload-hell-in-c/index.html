<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <link href='//fonts.googleapis.com/css?family=Source+Code+Pro|PT+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

  <!-- Tell mobile browsers we're optimized for them and they don't need to
       crop the viewport. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/rss.xml" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/atom.xml" />
  <link rel="stylesheet" href="/style.css" type="text/css" />

  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <title>
    Avoiding Overload Hell in C# &ndash; journal.stuffwithstuff.com
  </title>
</head>  <body>
    <div class="column">
<article>
<header>
<h1>
  <a href="/2008/02/26/avoiding-overload-hell-in-c/" rel="bookmark"
     title="Permanent Link to Avoiding Overload Hell in C#">
    Avoiding Overload Hell in C#
  </a>
</h1>
  <a class="older" href="/2008/02/09/c-extension-methods-not-just-for-breakfast/"
     title="Older Post &ldquo;C# Extension Methods: Not Just for Breakfast&rdquo;">&larr;</a>
  <a class="newer" href="/2008/03/05/checking-flags-in-c-enums/"
     title="Newer Post &ldquo;Checking Flags in C# Enums&rdquo;">&rarr;</a>
</header>
<h4><a href="/archive">February 26, 2008</a>
    <span class="tags"><a href="/category/c-sharp">c-sharp</a> <a href="/category/code">code</a></span>
</h4>
<div class="update">
<p><em>Update 2021/09/22:</em> C# got support for default parameters in 4.0.</p>
</div>

<p>C# <a href="https://docs.microsoft.com/en-us/archive/blogs/csharpfaq/does-c-have-default-parameters">lacks default parameters</a>. The C# answer to default params is overloaded
methods. With a lot of options, this can quickly <a href="http://msdn2.microsoft.com/en-us/library/system.drawing.graphics.drawimage.aspx">scale to hell</a>. Even if
it had default parameters, they are pretty limited too. This post talks a bit
about a couple of other solutions I found to the problem that avoid the
combinatorial sea of overloads.</p>

<h2>The problem</h2>

<p>For kicks, I wrote a little <a href="http://en.wikipedia.org/wiki/Curses_(programming_library)">curses</a>-like terminal library in C#. It only
really has a few core methods: <code>Write()</code> for writing text, <code>Fill()</code> to fill in a
space, and <code>Draw()</code> to draw lines and boxes using awesome ASCII lines. The
tricky part is that each of those can take a bunch of different parameters. For
our talk, we&rsquo;ll simplify it down:</p>

<ol>
<li><p><strong>Position:</strong> You can specify where on the screen to write using a <code>Point</code>,
x and y coordinates, or not at all to write at the current cursor position.</p></li>
<li><p><strong>Color:</strong> You can specify both the fore- and background color, just the
foreground color, or neither to use the current colors.</p></li>
</ol>

<p>And that&rsquo;s it. Three methods, and two kinds of parameters with three options
each.</p>

<h2>Overloads: the vanilla solution</h2>

<p>So the normal way to address this is by overloading <code>Write()</code>, <code>Fill()</code>, and
<code>Draw()</code>. If we go with the vanilla overload solution, we have 27 overloaded
methods to implement every combination. Using the code looks like this:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="t">Terminal</span> <span class="i">terminal</span> <span class="o">=</span> <span class="k">new</span> <span class="t">Terminal</span><span class="p">();</span>

<span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">.</span><span class="i">Fill</span><span class="p">(</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Red</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">.</span><span class="i">Draw</span><span class="p">(</span><span class="i">Color</span><span class="p">.</span><span class="i">Green</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Blue</span><span class="p">);</span>
</code></pre></div>
<p>Not bad. But implementing it looks like:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="k">public</span> <span class="k">class</span> <span class="t">Terminal</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">Point</span> <span class="i">pos</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">,</span>
        <span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">,</span>
        <span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">,</span> <span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">Point</span> <span class="i">pos</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">Point</span> <span class="i">pos</span><span class="p">,</span> <span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">,</span> <span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="t">Point</span> <span class="i">pos</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="t">Point</span> <span class="i">pos</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="t">Color</span> <span class="i">fore</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="t">Point</span> <span class="i">pos</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="t">Point</span> <span class="i">pos</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="t">Point</span> <span class="i">pos</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">,</span> <span class="t">Color</span> <span class="i">fore</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="t">Color</span> <span class="i">fore</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="t">Point</span> <span class="i">pos</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Lame! Worse, if you start adding more options, it goes up combinatorially. 27 is
just for our <em>toy</em> terminal. For my actual terminal lib, it would take <em>324</em>
overloaded methods to support every combination. There has to be a better way.</p>

<h2>Variable argument lists: who needs strong typing anyway?</h2>

<p>It&rsquo;s true that C# doesn&rsquo;t support default parameters, but it <em>does</em> support
variable length argument lists. Maybe that&rsquo;s a solution that lets us pass in a
variety of options without having to overload. Calling it still looks like:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="t">Terminal</span> <span class="i">terminal</span> <span class="o">=</span> <span class="k">new</span> <span class="t">Terminal</span><span class="p">();</span>

<span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">.</span><span class="i">Fill</span><span class="p">(</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Red</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">.</span><span class="i">Draw</span><span class="p">(</span><span class="i">Color</span><span class="p">.</span><span class="i">Green</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Blue</span><span class="p">);</span>
</code></pre></div>
<p>But the class itself just looks like:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="k">public</span> <span class="k">class</span> <span class="t">Terminal</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">string</span> <span class="i">text</span><span class="p">,</span> <span class="k">params</span> <span class="t">object</span><span class="p">[]</span> <span class="i">options</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="k">params</span> <span class="t">object</span><span class="p">[]</span> <span class="i">options</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="k">params</span> <span class="t">object</span><span class="p">[]</span> <span class="i">options</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>That doesn&rsquo;t look so bad. Except when you try to implement one of the methods:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">string</span> <span class="i">text</span><span class="p">,</span> <span class="k">params</span> <span class="t">object</span><span class="p">[]</span> <span class="i">options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="t">Point</span> <span class="i">pos</span> <span class="o">=</span> <span class="i">mCurrentPos</span><span class="p">;</span>
    <span class="t">Color?</span> <span class="i">foreColor</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="t">Color?</span> <span class="i">backColor</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="t">int?</span> <span class="i">x</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="t">int?</span> <span class="i">y</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="t">object</span> <span class="i">obj</span> <span class="k">in</span> <span class="i">options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="i">obj</span> <span class="k">is</span> <span class="t">Point</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="i">pos</span> <span class="o">=</span> <span class="p">(</span><span class="t">Point</span><span class="p">)</span><span class="i">obj</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="i">obj</span> <span class="k">is</span> <span class="t">Color</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="i">foreColor</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="i">foreColor</span> <span class="o">=</span> <span class="p">(</span><span class="t">Color</span><span class="p">)</span><span class="i">obj</span><span class="p">;</span>
            <span class="k">else</span> <span class="i">backColor</span> <span class="o">=</span> <span class="p">(</span><span class="t">Color</span><span class="p">)</span><span class="i">obj</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="i">obj</span> <span class="k">is</span> <span class="t">int</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="i">x</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="i">x</span> <span class="o">=</span> <span class="p">(</span><span class="t">int</span><span class="p">)</span><span class="i">obj</span><span class="p">;</span>
            <span class="k">else</span> <span class="i">y</span> <span class="o">=</span> <span class="p">(</span><span class="t">int</span><span class="p">)</span><span class="i">obj</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="i">x</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="i">x</span> <span class="o">=</span> <span class="i">mCurrentX</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="i">y</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="i">y</span> <span class="o">=</span> <span class="i">mCurrentY</span><span class="p">;</span>

    <span class="c">// write using pos, color, etc.</span>
<span class="p">}</span>
</code></pre></div>
<p>That&rsquo;s… just… no. And that doesn&rsquo;t even have any error handling. The following
is totally valid:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="n">17</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">White</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Aqua</span><span class="p">,</span>
    <span class="i">Color</span><span class="p">.</span><span class="i">Beige</span><span class="p">,</span> <span class="s">&quot;wtf?&quot;</span><span class="p">);</span>
</code></pre></div>
<p>OK, scratch that.</p>

<h2>Parameter object: strong typing is strong</h2>

<p>So we know we want strong typing. How about if we bundle all of the parameters
into a parameter object? This is basically the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.processstartinfo"><code>ProcessStartInfo</code></a>
solution.</p>

<p>We define a class something like:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="k">public</span> <span class="k">class</span> <span class="t">TerminalParams</span>
<span class="p">{</span>
    <span class="c">// Nullable so that null = default value.</span>
    <span class="k">public</span> <span class="t">Point?</span> <span class="i">Pos</span><span class="p">;</span>
    <span class="k">public</span> <span class="t">Color?</span> <span class="i">Fore</span><span class="p">;</span>
    <span class="k">public</span> <span class="t">Color?</span> <span class="i">Back</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>And our <code>Terminal</code> looks something like:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="k">public</span> <span class="k">class</span> <span class="t">Terminal</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">TerminalParams</span> <span class="i">paramObj</span><span class="p">,</span> <span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">(</span><span class="t">TerminalParams</span> <span class="i">paramObj</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">(</span><span class="t">TerminalParams</span> <span class="i">paramObj</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>In C# 3.0 with <a href="http://weblogs.asp.net/scottgu/archive/2007/03/08/new-c-orcas-language-features-automatic-properties-object-initializers-and-collection-initializers.aspx">object initializers</a>, we can call it something like:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="t">Terminal</span> <span class="i">terminal</span> <span class="o">=</span> <span class="k">new</span> <span class="t">Terminal</span><span class="p">();</span>

<span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span><span class="k">new</span> <span class="t">TerminalParams</span><span class="p">(),</span> <span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">.</span><span class="i">Fill</span><span class="p">(</span><span class="k">new</span> <span class="t">TerminalParams</span>
        <span class="p">{</span> <span class="i">Pos</span> <span class="o">=</span> <span class="k">new</span> <span class="t">Point</span><span class="p">(</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">),</span> <span class="i">Fore</span> <span class="o">=</span> <span class="i">Color</span><span class="p">.</span><span class="i">Red</span> <span class="p">});</span>
<span class="i">terminal</span><span class="p">.</span><span class="i">Draw</span><span class="p">(</span><span class="k">new</span> <span class="t">TerminalParams</span>
        <span class="p">{</span> <span class="i">Fore</span> <span class="o">=</span> <span class="i">Color</span><span class="p">.</span><span class="i">Green</span><span class="p">,</span> <span class="i">Back</span> <span class="o">=</span> <span class="i">Color</span><span class="p">.</span><span class="i">Blue</span> <span class="p">});</span>
</code></pre></div>
<p>I won&rsquo;t say that&rsquo;s the greatest thing ever, but it&rsquo;s not too bad. Of course, if
you&rsquo;re not on 3.0 yet, you&rsquo;re up a creek. All you&rsquo;ve basically accomplished is
moved your overloads to constructor overloads in <code>TerminalParams</code>. And I still
think there&rsquo;s a little too much… junk… in those lines of code. The <code>new TerminalParams {</code> and <code>new Point(...)</code> parts don&rsquo;t really add any value.</p>

<h2>Parameter groups</h2>

<p>Really, the overloaded methods do have the best <em>calling convention</em> so far.
Let&rsquo;s look at it a little closer:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Blue</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Red</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">);</span>
</code></pre></div>
<p>While that&rsquo;s an uninterrupted list of parameters, they&rsquo;re conceptually grouped
like this:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span>    <span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Blue</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Red</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="c">//             ^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^^  ^^^^</span>
<span class="c">//             Position  Color                  Text</span>
</code></pre></div>
<p>How cool would it be if we could actually group the parameters like that in
the code? Something like:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">)(</span><span class="i">Color</span><span class="p">.</span><span class="i">Blue</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Red</span><span class="p">)(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
</code></pre></div>
<p>C# doesn&rsquo;t have functors, but maybe we&rsquo;re on to something.</p>

<p><em>Insert several hours of mucking around with properties that return delegates
that return delegates, etc.</em></p>

<p>Or… not. But let&rsquo;s not give up yet. Let&rsquo;s try re-arranging things:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)(</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">)(</span><span class="i">Color</span><span class="p">.</span><span class="i">Blue</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Red</span><span class="p">);</span>
</code></pre></div>
<p>This is a little better because it puts the method (<code>Write()</code>) next to the one
parameter it really needs, the string. The problem is that that line, if it
were possible to write, would execute from left to right. So we would have to
write before we looked at the parameters.</p>

<p>Let&rsquo;s do some more shuffling:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="i">terminal</span><span class="p">(</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">)(</span><span class="i">Color</span><span class="p">.</span><span class="i">Blue</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Red</span><span class="p">).</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
</code></pre></div>
<p>This looks promising, but we&rsquo;re stuck with the fact that C# doesn&rsquo;t have
functors. We can&rsquo;t do <code>terminal()</code>. Is there anything that sort of <em>looks</em>
like <code>()</code>?</p>

<h2>You&rsquo;re using what?!</h2>

<p>So the question is, &ldquo;what kind of grouping construct can we define at the object
level?&rdquo; Astute readers are already thinking it: <em>indexers</em>. Right now, some of
you may be shuddering in horror at the weirdness we&rsquo;re about to unleash, but
let&rsquo;s do it anyway. Can we make all of these lines of code work:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">[</span><span class="k">new</span> <span class="t">Point</span><span class="p">(</span><span class="n">3</span><span class="p">,</span> <span class="n">4</span><span class="p">)].</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">[</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">][</span><span class="a">Color.Red</span><span class="p">].</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">[</span><span class="i">Color</span><span class="p">.</span><span class="i">Brown</span><span class="p">].</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">[</span><span class="i">Color</span><span class="p">.</span><span class="i">Green</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Blue</span><span class="p">].</span><span class="i">Draw</span><span class="p">();</span>
</code></pre></div>
<p>And can we make them work all at the same time? Not only that, can we make the
following <em>not</em> work:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="c">// Bad, cannot specify position twice.</span>
<span class="i">terminal</span><span class="p">[</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">][</span><span class="a">new</span> <span class="i">Point</span><span class="p">(</span><span class="n">3</span><span class="p">,</span> <span class="n">4</span><span class="p">)].</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>

<span class="c">// Bad, cannot specify half a position.</span>
<span class="i">terminal</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>

<span class="c">// Sorta bad, for consistency would always like</span>
<span class="c">// to have position before color.</span>
<span class="i">terminal</span><span class="p">[</span><span class="i">Color</span><span class="p">.</span><span class="i">Brown</span><span class="p">][</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">].</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
</code></pre></div>
<p>It turns out, we can. The core idea is to define a chain of interfaces that
inherit from each other.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="k">public</span> <span class="k">interface</span> <span class="t">ITerminalMethods</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">string</span> <span class="i">text</span><span class="p">);</span>
    <span class="k">void</span> <span class="i">Fill</span><span class="p">();</span>
    <span class="k">void</span> <span class="i">Draw</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="t">ITerminalColor</span> <span class="p">:</span> <span class="t">ITerminalMethods</span>
<span class="p">{</span>
    <span class="t">ITerminalMethods</span> <span class="i">this</span><span class="p">[</span><span class="t">Color</span> <span class="i">fore</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="t">ITerminalMethods</span> <span class="i">this</span><span class="p">[</span><span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="t">ITerminalPosColor</span> <span class="p">:</span> <span class="t">ITerminalColor</span>
<span class="p">{</span>
    <span class="t">ITerminalColor</span> <span class="i">this</span><span class="p">[</span><span class="t">Point</span> <span class="i">pos</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="t">ITerminalColor</span> <span class="i">this</span><span class="p">[</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="t">ITerminal</span> <span class="p">:</span> <span class="t">ITerminalPosColor</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div>
<p>Each one represents one of the parameter types: position, color, etc. The
innermost one, <code>ITerminalMethods</code>, contains the actual methods, <code>Write()</code>,
<code>Fill()</code>, etc.</p>

<p>The other interfaces define indexers for each parameter type that return the
next interface up the chain. The position interface, <code>ITerminalPosColor</code>, has
indexers that return the color interface, <code>ITerminalColor</code>, which has indexers
which return the method interface, <code>ITerminalMethods</code>. Since the interfaces
inherit from each other too, you can also skip a step. You can go from
<code>ITerminalPosColor</code> straight to <code>ITerminalMethods</code> because <code>ITerminalColor</code>
interface inherits from it.</p>

<p>Calling it looks like:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="i">terminal</span><span class="p">.</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">[</span><span class="k">new</span> <span class="t">Point</span><span class="p">(</span><span class="n">3</span><span class="p">,</span> <span class="n">4</span><span class="p">)].</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">[</span><span class="n">1</span><span class="p">,</span> <span class="n">2</span><span class="p">][</span><span class="a">Color.Red</span><span class="p">].</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">[</span><span class="i">Color</span><span class="p">.</span><span class="i">Brown</span><span class="p">].</span><span class="i">Write</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
<span class="i">terminal</span><span class="p">[</span><span class="i">Color</span><span class="p">.</span><span class="i">Green</span><span class="p">,</span> <span class="i">Color</span><span class="p">.</span><span class="i">Blue</span><span class="p">].</span><span class="i">Draw</span><span class="p">();</span>
</code></pre></div>
<p>This is all well and good for <em>defining</em> it, but is it possible to actually
<em>implement</em> this thing?</p>

<p>We can do that too. The idea is that the Terminal class really contains two
kinds of state: the core &ldquo;set of characters on screen&rdquo; state and the ephemeral
state that can be overridden by these indexers&mdash;current color and position. We
let a Terminal create a shallow clone of itself that <em>shares</em> the core state,
but has a <em>copy</em> of the ephemeral state that can be changed. All of the indexers
create new Terminals that write to the same core terminal data but keep their
own copy of the position and color. Like so:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span></span><span class="k">public</span> <span class="k">class</span> <span class="t">TerminalData</span>
<span class="p">{</span>
    <span class="c">// Terminal core state:</span>
    <span class="k">public</span> <span class="t">char</span><span class="p">[]</span> <span class="i">Characters</span><span class="p">;</span>
    <span class="k">public</span> <span class="t">Color</span><span class="p">[]</span> <span class="i">ForeColors</span><span class="p">;</span>
    <span class="k">public</span> <span class="t">Color</span><span class="p">[]</span> <span class="i">BackColors</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="t">Terminal</span> <span class="p">:</span> <span class="t">ITerminal</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="i">Terminal</span><span class="p">()</span> <span class="p">{</span> <span class="i">mData</span> <span class="o">=</span> <span class="k">new</span> <span class="t">TerminalData</span><span class="p">();</span> <span class="p">}</span>

    <span class="r">#region ITerminalPosColor Members</span>

    <span class="k">public</span> <span class="t">ITerminalColor</span> <span class="i">this</span><span class="p">[</span><span class="t">Point</span> <span class="i">pos</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="t">Terminal</span><span class="p">(</span><span class="i">mData</span><span class="p">,</span> <span class="i">pos</span><span class="p">,</span> <span class="i">mFore</span><span class="p">,</span> <span class="i">mBack</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="t">ITerminalColor</span> <span class="i">this</span><span class="p">[</span><span class="t">int</span> <span class="i">x</span><span class="p">,</span> <span class="t">int</span> <span class="i">y</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="t">Terminal</span><span class="p">(</span><span class="i">mData</span><span class="p">,</span>
            <span class="k">new</span> <span class="t">Point</span><span class="p">(</span><span class="i">x</span><span class="p">,</span> <span class="i">y</span><span class="p">),</span> <span class="i">mFore</span><span class="p">,</span> <span class="i">mBack</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="r">#endregion</span>

    <span class="r">#region ITerminalColor Members</span>

    <span class="k">public</span> <span class="t">ITerminalMethods</span> <span class="i">this</span><span class="p">[</span><span class="t">Color</span> <span class="i">fore</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="t">Terminal</span><span class="p">(</span><span class="i">mData</span><span class="p">,</span> <span class="i">mPos</span><span class="p">,</span> <span class="i">fore</span><span class="p">,</span> <span class="i">mBack</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="t">ITerminalMethods</span> <span class="i">this</span><span class="p">[</span><span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="t">Terminal</span><span class="p">(</span><span class="i">mData</span><span class="p">,</span> <span class="i">mPos</span><span class="p">,</span> <span class="i">fore</span><span class="p">,</span> <span class="i">back</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="r">#endregion</span>

    <span class="r">#region ITerminalMethods Members</span>

    <span class="k">public</span> <span class="k">void</span> <span class="i">Write</span><span class="p">(</span><span class="t">string</span> <span class="i">text</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Fill</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="i">Draw</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="r">#endregion</span>

    <span class="k">private</span> <span class="i">Terminal</span><span class="p">(</span><span class="t">TerminalData</span> <span class="i">data</span><span class="p">,</span> <span class="t">Point</span> <span class="i">pos</span><span class="p">,</span>
        <span class="t">Color</span> <span class="i">fore</span><span class="p">,</span> <span class="t">Color</span> <span class="i">back</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="i">mData</span> <span class="o">=</span> <span class="i">data</span><span class="p">;</span>
        <span class="i">mPos</span>  <span class="o">=</span> <span class="i">pos</span><span class="p">;</span>
        <span class="i">mFore</span> <span class="o">=</span> <span class="i">fore</span><span class="p">;</span>
        <span class="i">mBack</span> <span class="o">=</span> <span class="i">back</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="t">TerminalData</span> <span class="i">mData</span><span class="p">;</span>

    <span class="c">// Ephemeral state:</span>
    <span class="k">private</span> <span class="t">Point</span> <span class="i">mPos</span><span class="p">;</span>
    <span class="k">private</span> <span class="t">Color</span> <span class="i">mFore</span><span class="p">;</span>
    <span class="k">private</span> <span class="t">Color</span> <span class="i">mBack</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2>Is it worth doing?</h2>

<p>So this is how <a href="https://github.com/munificent/malison-dotnet/blob/master/Malison.Core/ITerminal.cs">my little terminal library</a> works, and I&rsquo;ve grown
pretty fond of it. However, this is a personal project, so my willingness to
deal with very idiomatically strange code is pretty high. (Ask me about
<a href="/2008/04/08/whats-the-opposite-of-nullable/"><code>NotNull&lt;T&gt;</code></a> sometime.)</p>

<p>In a production environment, this might be too strange looking for some teams.
But maybe if it gets popularized enough what was once strange will become
familiar.</p>
  <div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'journal-stuffwithstuff';
        var disqus_url = "https://journal.stuffwithstuff.com/2008/02/26/avoiding-overload-hell-in-c/";

        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</article>
<nav>
  <div class="nav-first">
    <a href="/"><img src="/image/dogshot_square.jpg" class="bob"></a>
    <p>Hi! I'm <strong>Bob Nystrom</strong>, the one on the left. I wrote <a href="https://gameprogrammingpatterns.com/"><strong>Game Programming Patterns</strong></a> and <a href="https://craftinginterpreters.com"><strong>Crafting Interpreters</strong></a>.</p>
    <p>I make electronic music under the name <a href="https://tinywir.es/"><strong>Tiny Wires</strong></a>.</p>
    <p>You can follow me on Mastodon at <a href="https://mastodon.social/@munificent"><code>@munificent</code></a> or email me at <code>robert</code> at this site.</p>
  </div>
  <div class="nav-second">
    <h2>Tags</h2>
    <ul>
      <li><a href="/category/code">code</a></li>
      <li><a href="/category/language">language</a></li>
      <li><a href="/category/magpie">magpie</a></li>
      <li><a href="/category/c-sharp">c-sharp</a></li>
      <li><a href="/category/dart">dart</a></li>
      <li><a href="/category/game-dev">game-dev</a></li>
      <li><a href="/category/java">java</a></li>
      <li><a href="/category/cpp">cpp</a></li>
      <li><a href="/category/design">design</a></li>
      <li><a href="/category/game-patterns">game-patterns</a></li>
      <li><a href="/category/go">go</a></li>
      <li><a href="/category/parsing">parsing</a></li>
      <li><a href="/category/roguelike">roguelike</a></li>
      <li><a href="/category/book">book</a></li>
      <li><a href="/category/personal">personal</a></li>
      <li><a href="/category/js">js</a></li>
      <li><a href="/category/c">c</a></li>
      <li><a href="/category/finch">finch</a></li>
      <li><a href="/category/python">python</a></li>
      <li><a href="/category/ruby">ruby</a></li>
      <li><a href="/category/blog">blog</a></li>
      <li><a href="/category/f-sharp">f-sharp</a></li>
      <li><a href="/category/javascript">javascript</a></li>
      <li><a href="/category/lua">lua</a></li>
      <li><a href="/category/music">music</a></li>
    </ul>
    <p class="archive"><a href="/archive">All articles&hellip;</a></p>
<p>This blog is built using a bespoke static site generator. The source repo
is <a href="https://github.com/munificent/journal">here</a>.</p>
<p class="copyright">&copy; 2008-2025 Bob Nystrom</p>
  </div>
</nav>    </div>
  </body>
</html>
